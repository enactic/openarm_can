# Copyright 2025 Enactic, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

require "fileutils"

require_relative "../../helper"

version = ENV["VERSION"] || Helper.detect_version

desc "Create RPM spec file"
task :spec do
  FileUtils.copy_file("openarm-can.spec.in", "openarm-can.spec")
  current_version = Helper.detect_version
  Helper.update_content("openarm-can.spec") do |content|
      content.sub!("@VERSION@", current_version)
  end
  executable_files = Array.new()
  File.readlines('../../CMakeLists.txt', chomp: true).each do |line|
      if !!(line =~ /install\(TARGETS openarm-can-*.* DESTINATION \${CMAKE_INSTALL_BINDIR}\)/)
          executable=line.delete_prefix("install(TARGETS ").delete_suffix(" DESTINATION ${CMAKE_INSTALL_BINDIR})")
          executable_files.append("%{_bindir}/" + executable)
      end
      if !!(line =~ /setup\/openarm-can-[a-z0-9\-]/)
          /(?<rhs>.+)\s*setup\/\s*(?<executable>.+)/ =~ line
          executable_files.append("%{_bindir}/" + executable)
      end
  end
  executable_files.sort!
  Helper.update_content("openarm-can.spec") do |content|
      content.sub!("@EXECUTABLES@", executable_files.join("\n"))
  end
end
